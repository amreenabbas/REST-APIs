#!/usr/bin/python

from flask import Flask, request
from tinydb import TinyDB, Query, where
from werkzeug.security import generate_password_hash, check_password_hash
import json
from flask_httpauth import HTTPBasicAuth
from datetime import datetime
import random
import string
import time
import hashlib

db = TinyDB('db.json')
query = Query()
group = db.table('group')
device = db.table('device')
dstate = db.table('dstate')
res = db.table('reservation')
conf = db.table('configuration')
asynct = db.table('asynct')
users = db.table('users')
app = Flask(__name__)
auth = HTTPBasicAuth()


@app.route("/signup", methods=["POST"])
def add_user():
    body = json.loads(request.data)
    user_id = body["id"]
    if users.search(query.id == user_id):
        return 'Id already exists, status=409'
    user_password = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(3)])
    salt = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(5)])
    h = user_id + salt + user_password
    users.insert({"id": user_id, "salt" : salt ,"password": generate_password_hash(h), "type" : "user"})
    return 'user added, password : %s ,status=201'% user_password

@app.route("/login", methods=["POST"])
def login():
    user_ = json.loads(request.data)
    uid = user_["id"]
    pwd = user_["password"]
    if users.search(where('id') == uid):
        if verify_password(uid,pwd):
            return 'status=200'
        else:
            return 'invalid password, status=403'
    else:
        return 'invalid id'
def verify_password(uid,pwd):
    info = users.search(where('id') == uid)
    if info:
        salt = info[0]['salt']
        passw = uid + salt + pwd
        if check_password_hash( info[0]['password'],passw):
            return True
        else:
            return False
    else:
        return False

@app.route('/groups',methods = ['POST'])

def crgroup():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
        g = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
        group.insert({'gid' : g, 'resources' : user["resources"], 'uid' : uid})
        return 'group-id %s'%g
    else:
        return 'invalid user id or password'


@app.route('/groups/<gid>',methods = ['PUT','DELETE'])

def upgroup(gid):
    if request.method == 'PUT':
        uid = request.headers['id']
        pwd = request.headers['password']
        if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
            if group.count((where('gid') == gid) & (where('uid') == uid)):
                user = json.loads(request.data)
                group.update({'resources': user["resources"]}, (query.gid == gid) & (query.uid == uid))
                return '200 OK'
            else:
                return 'invalid user id or gid'
        else:
            return 'invalid user id or password'

    elif request.method == 'DELETE':
        uid = request.headers['id']
        pwd = request.headers['password']
        if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
            if group.count((where('gid') == gid) & (where('uid') == uid)):
                group.remove((where('gid') == gid) & (where('uid') == uid))
                return '200 OK'
            else:
                return ' gid not found'
        else:
            return 'invalid user id or password'


@app.route('/reservations',methods=['POST'])

def reserve():
    user = json.loads(request.data)
    did = user.get("did")
    gid = user.get("gid")
    uid = request.headers['id']
    pwd = request.headers['password']
    st_obj = datetime.strptime(user["start-time"], '%Y-%m-%d %H:%M:%S')
    et_obj = datetime.strptime(user["end-time"], '%Y-%m-%d %H:%M:%S')
    s = time.mktime(st_obj.timetuple())
    e = time.mktime(et_obj.timetuple())
    if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
        if group.count((where('gid') == gid) & (where('uid') == uid)):
            if res.search((where('gid') == gid) & (where('start-time') <= s) & (where('end-time') >= e)):
                return 'already reserved'
            else:
                r = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                p = priority()
                res.insert({'gid': gid, 'rid': r, 'start-time': s,  'end-time': e, 'priority': p,'uid' : uid})
                return 'reservation-id %s' % r
        elif device.count((where('did') == did) & (where('uid') == uid)):
            if res.search((where('did') == did) & (where('start-time') <= user["start-time"]) & (where('end-time') >= user["end-time"])):
                return 'already reserved'
            else:
                r = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                p = priority()
                res.insert({'did': did, 'rid': r, 'start-time': s,  'end-time': e, 'priority': p,'uid' : uid})
                return 'reservation-id %s' % r
        else:
            return 'invalid gid/did or user id'
    else:
        return 'invalid user id or password'

@app.route('/reservations/<rid>', methods=['PUT','DELETE'])

def upreserve(rid):
    if request.method == 'PUT':
        uid = request.headers['id']
        pwd = request.headers['password']
        if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
            if res.search((where('rid') == rid) & (where('uid') == uid)):
                user = json.loads(request.data)
                if (user.get("start-time") != None) & (user.get("end-time") != None):
                    st_obj = datetime.strptime(user.get("start-time"), '%Y-%m-%d %H:%M:%S')
                    et_obj = datetime.strptime(user.get("end-time"), '%Y-%m-%d %H:%M:%S')
                    s = time.mktime(st_obj.timetuple())
                    e = time.mktime(et_obj.timetuple())
                    res.update({'start-time': s, 'end-time': e},query.rid == rid)
                elif user.get("start-time"):
                    st_obj = datetime.strptime(user.get("start-time"), '%Y-%m-%d %H:%M:%S')
                    s = time.mktime(st_obj.timetuple())
                    res.update({'start-time': s}, query.rid == rid)
                elif user.get("end-time"):
                    et_obj = datetime.strptime(user.get("end-time"), '%Y-%m-%d %H:%M:%S')
                    e = time.mktime(et_obj.timetuple())
                    res.update({'end-time': e}, query.rid == rid)
                return '200 OK'
            else:
                return 'invalid user id or rid'
        else:
            return 'invalid user id or password'

    elif request.method == 'DELETE':
        uid = request.headers['id']
        pwd = request.headers['password']
        if (users.count(where('id') == uid)) & (verify_password(uid,pwd)):
            if res.count((where('rid') == rid) & (where('uid') == uid)):
                res.remove((query.rid == rid) & (query.uid == uid))
                return '200 OK'
            else:
                return 'invalid user id or rid'
        else:
            return 'invalid user id or password'

@app.route('/sync-configurations', methods=['POST','PUT','DELETE'])

def configure():
    if request.method == 'POST':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        gid = user.get('gid')
        did = user.get('did')
        cid = user.get('cid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.search((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.insert({'configurations' : user["configurations"], 'gid' : gid, 'rid' : user["rid"]})
                    return 'created configurations'
                elif res.search((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.insert({'configurations' : user["configurations"], 'did' : did, 'rid' : user["rid"]})
                    return 'created configurations'
                else:
                    return 'rid and gid/did not found or channel not active'
            else:
                if group.count((where('gid') == gid) & (where('uid') == uid) & (where('uid') == uid)):
                    conf.insert({'configurations': user["configurations"], 'gid': gid})
                    return 'created configurations'
                elif device.count((where('did') == did) & (where('uid') == uid) & (where('uid') == uid)):
                    conf.insert({'configurations': user["configurations"], 'did': did})
                    return 'created configurations'
                else:
                    return 'invalid gid/did or user id'
        else:
            return 'invalid user id or password'

    if request.method == 'PUT':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        cid = user.get('cid')
        gid = user.get('gid')
        did = user.get('gid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.search((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({'configurations' : user["configurations"]},(query.rid == user["rid"]) & (query.gid == gid))
                    return '200 OK'
                elif res.search((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({'configurations' : user["configurations"]},(query.rid == user["rid"]) & (query.did == did))
                    return '200 OK'
                else:
                    return 'rid and gid/did not found or channel not active'
            else:
                if conf.count((where('gid') == gid)& (where('uid') == uid)):
                    conf.update({'configurations': user["configurations"]}, query.gid == gid)
                    return '200 OK'
                elif conf.count((where('did') == did)& (where('uid') == uid)):
                    conf.update({'configurations': user["configurations"]}, query.did == did)
                    return '200 OK'
                else:
                    return 'invalid gid/did or configurations not created'
        else:
            return 'invalid user id or password'

    elif request.method == 'DELETE':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        cid = user.get('cid')
        did = user.get('did')
        gid = user.get('gid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.search((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.remove((where('rid') == user["rid"]) & (where('gid') == gid))
                    return '200 OK'
                elif res.search((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.remove((where('rid') == user["rid"]) & (where('did') == did))
                    return '200 OK'
                else:
                    return 'rid and gid/did not found or channel not active'
            else:
                if conf.count((where('gid') == gid) & (where('uid') == uid)):
                    conf.remove(where('gid') == gid)
                    return '200 OK'
                elif conf.count((where('did') == did) & (where('uid') == uid)):
                    conf.remove(where('did') == did)
                    return '200 OK'
                else:
                    return 'configurations not created for given gid/did'
        else:
            return 'invalid user id or password'

@app.route('/sync-write', methods=['POST','PUT','DELETE'])

def write():
    if request.method == 'POST':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        cid = user.get('cid')
        did = user.get('did')
        gid = user.get('gid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({ 'content': user["content"]},(query.rid == user["rid"]) & (query.gid == gid))
                    return 'data saved'
                elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]},(query.rid == user["rid"]) & (query.did == did))
                    return 'data saved'
                else:
                    return 'rid and gid/did not found or channel not active'
            else:
                if group.count((where('gid') == gid) & (where('uid') == uid) & (where('uid') == uid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]}, query.gid == gid)
                    return 'data saved'
                elif group.count((where('did') == did) & (where('uid') == uid) & (where('uid') == uid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]}, query.did == did)
                    return 'data saved'
                else:
                    return 'invalid gid/did'
        else:
            return 'invalid user id or password'

    if request.method == 'PUT':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        cid = user.get('cid')
        did = user.get('did')
        gid = user.get('gid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]},(query.rid == user["rid"]) & (query.gid == gid))
                    return '200 OK'
                elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]},(query.rid == user["rid"]) & (query.did == did))
                    return '200 OK'
                else:
                    return 'rid and gid not found or channel not active'
            else:
                if conf.search((where('gid') == gid) & (where('uid') == uid)):
                    conf.update({'content': user["content"]},query.gid == gid)
                    return '200 OK'
                elif conf.search((where('did') == did)& (where('uid') == uid)):
                    conf.update({'content': user["content"]},query.did == did)
                    return '200 OK'
                else:
                    return 'data not written to the given gid/did'
        else:
            return 'invalid user id or password'

    elif request.method == 'DELETE':
        user = json.loads(request.data)
        uid = request.headers['id']
        pwd = request.headers['password']
        cid = user.get('cid')
        did = user.get('did')
        gid = user.get('gid')
        if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
            i = users.search(where('id') == uid)
            if i[0]['type'] == "user":
                if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({"content" : ""},(query.rid == user["rid"]) & (query.gid == gid))
                    return '200 OK'
                elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('cid') == cid) & (where('uid') == uid)):
                    conf.update({"content" : ""},(query.rid == user["rid"]) & (query.did == did))
                    return '200 OK'
                else:
                    return 'gid and rid not found or channel not active'
            else:
                if conf.search((where('gid') == gid)& (where('uid') == uid)):
                    conf.remove(where('gid') == gid)
                    return '200 OK'
                elif conf.search((where('did') == did)& (where('uid') == uid)):
                    conf.remove(where('did') == did)
                    return '200 OK'
                else:
                    return 'no data written for given gid/did'
        else:
            return 'invalid user id or password'

@app.route('/operational-status', methods=['POST'])

def opstat():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    did = user.get('did')
    gid = user.get('gid')
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        i = users.search(where('id') == uid)
        if i[0]['type'] == "user":
            if group.count(where('gid') == gid):
                st = dstate.search(where('id') == gid)
                if st:
                    return 'device status : active , rid : %s' % st[0]['rid']
                else:
                    return 'device status : inactive'
            elif device.count(where('did') == did):
                st = dstate.search(where('id') == did)
                if st:
                    return 'device status : active , rid : %s' % st[0]['rid']
                else:
                    return 'device status : inactive'
            else:
                return 'rid and did not found'
        else:
            if group.count(where('gid') == gid):
                st = dstate.search(where('id') == gid)
                if st:
                    return 'device status : active , rid : %s' % st[0]['rid']
                else:
                    return 'device status : inactive'
            elif device.count(where('did') == user["did"]):
                st = dstate.search(where('id') == did)
                if st:
                    return 'device status : active , rid : %s' % st[0]['rid']
                else:
                    return 'device status : inactive'
            else:
                return 'invalid did/gid'
    else:
        return 'invalid user id or password'

@app.route('/device-status',methods = ['POST'])

def devstat():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    did = user.get('did')
    gid = user.get('gid')
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        i = users.search(where('id') == uid)
        if i[0]['type'] == "user":
            if group.count (where('gid') == gid):
                if conf.count((where('rid') == user.get("rid")) & (where('gid') == gid)):
                    st = conf.search((where('rid') == user.get("rid")) & (where('gid') == gid))
                    return '%s' % st[0]['configurations']
                else:
                    return 'no configurations created'
            elif device.count(where('did') == did):
                if conf.count((where('rid') == user.get("rid")) & (where('did') == did)):
                    st = conf.search((where('rid') == user.get("rid")) & (where('did') == did))
                    return '%s' % st[0]['configurations']
                else:
                    return 'no configurations created'
            else:
                return 'rid and gid/did not found'
        else:
            if group.count(where('gid') == gid):
                st = conf.search(where('gid') == gid)
                if st:
                    return '%s' % st[0]['configurations']
                else:
                    return 'no configurations created'
            elif group.count(where('did') == did):
                st = conf.search(where('did') == did)
                if st:
                    return '%s' % st[0]['configurations']
                else:
                    return 'no configurations created'
            else:
                return 'invalid gid/did'
    else:
        return 'invalid user id or password'

@app.route('/async-configurations', methods=['POST'])

def asyncconfigure():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    did = user.get('did')
    gid = user.get('gid')
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('uid') == uid)):
            asynct.insert({'rid': user["rid"], 'gid': user["gid"], 'configurations': user["configurations"]})
            return '200 OK'
        elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('uid') == uid)):
            asynct.insert({'rid': user["rid"], 'did': did, 'configurations': user["configurations"]})
            return '200 OK'
        else:
            return 'rid and gid/did not found'
    else:
        return 'invalid user id or password'

@app.route('/async-write',methods = ['POST'])

def asyncwrite():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    did = user.get('did')
    gid = user.get('gid')
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('uid') == uid)):
            asynct.update({'rid': user["rid"], 'gid': gid, 'content': user["content"]},(query.rid == user["rid"]) & (query.gid == gid))
            return '200 OK'
        elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('uid') == uid)):
            asynct.update({'rid': user["rid"], 'did': did, 'content': user["content"]},(query.rid == user["rid"]) & (query.did == did))
            return '200 OK'
        else:
            return 'rid and gid/did not found'
    else:
        return 'invalid user id or password'


@app.route('/open/channel',methods = ['POST'])

def opchannel():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    did = user.get('did')
    gid = user.get('gid')
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        if res.count((where('rid') == user["rid"]) & (where('gid') == gid) & (where('uid') == uid)):
            n = datetime.now()
            info1 = res.search((where('rid') == user["rid"]) & (where('gid') == gid))
            now = time.mktime(n.timetuple())
            st = info1[0]['start-time']
            et = info1[0]['end-time']
            if (now >= st) & (et >= now):
                r = dstate.search(where('id') == gid)
                if r:
                    t = res.search(where('rid') == r[0]["rid"])
                    if info1[0]["priority"] > t[0]["priority"]:
                        cid = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                        res.update({'cid' : cid}, (query.rid == user["rid"]) & (query.gid == gid))
                        info = conf.search((where('rid') == user["rid"]) & (where('gid') == gid))
                        obj = asynct.search((query.rid == user["rid"]) & (query.gid == gid))
                        if (not info) & obj:
                            conf.insert({'configurations': obj[0]['configurations'],'content' : obj[0]['content'], 'rid' : user["rid"], 'gid' : gid})
                        dstate.update({'state' : "paused"},(query.id == r[0]["gid"]) & (query.rid == r[0]["rid"]))
                        dstate.insert({'cid' : cid, 'rid' : user["rid"], 'state' : 'active','id' : gid})
                        return 'channel-id is %s'%cid
                    else:
                        return 'high priority task executing'
                else:
                    cid = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                    res.update({"cid": cid}, (query.rid == user["rid"]) & (query.gid == gid))
                    info = conf.search((where('rid') == user["rid"]) & (where('gid') == gid))
                    obj1 = asynct.count((query.rid == user["rid"]) & (query.gid == gid))
                    if (not info) & obj1:
                        obj = asynct.search((query.rid == user["rid"]) & (query.gid == gid))
                        conf.insert({'configurations': obj[0]['configurations'], 'content': obj[0]['content'], 'rid': user["rid"], 'gid': gid})
                    dstate.insert({'cid': cid, 'rid': user["rid"], 'state': 'active', 'id': gid})
                    return 'channel-id is %s' % cid
            else:
                return 'time outside reservation time'
        elif res.count((where('rid') == user["rid"]) & (where('did') == did) & (where('uid') == uid)):
            n = datetime.now()
            info1 = res.search((where('rid') == user["rid"]) & (where('did') == did))
            now = time.mktime(n.timetuple())
            et = info1[0]['end-time']
            st = info1[0]['start-time']
            if (now >= st) & (et >= now):
                r = dstate.search(where('id') == did)
                if r:
                    t = res.search(where('rid') == r[0]["rid"])
                    if info1[0]["priority"] > t[0]["priority"]:
                        cid = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                        res.update({'cid' : cid}, (query.rid == user["rid"]) & (query.did == did))
                        info = conf.search((where('rid') == user["rid"]) & (where('did') == did))
                        if not info:
                            obj = asynct.search((query.rid == user["rid"]) & (query.did == did))
                            conf.insert({'configurations': obj[0]['configurations'],'content' : obj[0]['content'], 'rid' : user["rid"], 'did' : did})
                        dstate.update({'state' : "paused"},(query.id == r[0]["did"]) & (query.rid == r[0]["rid"]))
                        dstate.insert({'cid' : cid, 'rid' : user["rid"], 'state' : 'active','id' : did})
                        return 'channel-id is %s'%cid
                    else:
                        return 'high priority task executing'
                else:
                    cid = "".join([random.choice(string.ascii_lowercase + string.digits) for i in range(32)])
                    res.update({"cid": cid}, (query.rid == user["rid"]) & (query.did == did))
                    info = conf.search((where('rid') == user["rid"]) & (where('did') == did))
                    if not info:
                        obj = asynct.search((query.rid == user["rid"]) & (query.did == did))
                        conf.insert({'configurations': obj[0]['configurations'], 'content': obj[0]['content'], 'rid': user["rid"], 'did': did})
                    dstate.insert({'cid': cid, 'rid': user["rid"], 'state': 'active', 'id': did})
                    return 'channel-id is %s' % cid
            else:
                return 'time outside reservation time'
        else:
            return 'gid/did and rid not found'
    else:
        return 'invalid user id or password'

@app.route('/close/channel',methods = ['POST'])

def clchannel():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        info = res.search(((where('rid') == user["rid"]) | (where('cid') == user["cid"])) & (where('uid') == uid))
        if info:
            n = datetime.now()
            now = time.mktime(n.timetuple())
            et_obj = info[0]['end-time']
            if ( now > et_obj):
                res.remove((where('cid') == user["cid"]) | (where ('rid') == user["rid"]))
                conf.remove(where ('rid') == user["rid"])
                asynct.remove(where('rid') == user["rid"])
                dstate.remove(where('cid') == user["cid"])
                return 'reservation time exceeded'
            else:
                res.remove((where('cid') == user["cid"]) | (where('rid') == user["rid"]))
                conf.remove(where('rid') == user["rid"])
                asynct.remove(where('rid') == user["rid"])
                dstate.remove(where('cid') == user["cid"])
                return 'channel closed'
        else:
            return 'cid or rid does not exist'
    else:
        return 'invalid user id or password'

@app.route('/suspend/channel', methods=['POST'])

def schannel():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        info = res.search(((where('rid') == user["rid"]) | (where('cid') == user["cid"])) & (where('uid') == uid))
        if info:
            now = datetime.now()
            et_obj = info[0]['end-time']
            now_obj = time.mktime(now.timetuple())
            if (now_obj < et_obj):
                dstate.update({"pause-time": now_obj, "state": "paused"}, (query.id == user["gid"]) & (query.cid == user["cid"]))
                return 'channel suspended'
            else:
                st = res.search(where('cid') == user["cid"])
                conf.remove(where('rid') == st["rid"])
                asynct.remove(where('rid') == st["rid"])
                res.remove(where('cid') == user["cid"])
                dstate.remove(where('cid') == user["cid"])
                return 'reservation time exceeded '
        else:
            return 'cid or rid does not exist'
    else:
        return 'invalid user id or password'

@app.route('/resume/channel', methods=['POST'])

def rchannel():
    user = json.loads(request.data)
    uid = request.headers['id']
    pwd = request.headers['password']
    if (users.count(where('id') == uid)) & (verify_password(uid, pwd)):
        info = res.search(((where('rid') == user["rid"]) | (where('cid') == user["cid"])) & (where('uid') == uid))
        if info:
            n = datetime.now()
            et_obj = info[0]['end-time']
            now = time.mktime(n.timetuple())
            if (now > et_obj):
                st = res.search(where('cid') == user["cid"])
                conf.remove(where('rid') == st["rid"])
                asynct.remove(where('rid') == st["rid"])
                res.remove(where('cid') == user["cid"])
                dstate.remove(where('cid') == user["cid"])
                return 'reservation time exceeded '
            else:
                dstate.update({"resume-time": now, "state": "active"}, (query.id == user["gid"]) & (query.cid == user["cid"]))
                return 'channel resumed'
        else:
            return 'cid or rid does not exist'
    else:
        return 'invalid user id or password'

def priority():
    return 'low'

if __name__ == '__main__':
    app.run(debug = True)
